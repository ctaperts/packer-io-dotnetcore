{
  "builders": [
    {
      "type": "digitalocean",
      "ssh_username": "root",
      "api_token": "{{ user `secret_api_token` }}",
      "droplet_name": "building-image-net-core-sftp-pg",
      "snapshot_name": "packer .netcore {{isotime \"02-Jan-06 03:04:05\"}}",
      "image": "ubuntu-16-04-x64",
      "region": "nyc3",
      "size": "512mb"
    }
  ],
  "provisioners": [
    {
      "source": "./files/kestrel-aspnetcore.service",
      "destination": "/tmp/kestrel-aspnetcore.service",
      "type": "file"
    },
    {
      "source": "./files/aspnetcore.conf",
      "destination": "/tmp/aspnetcore.conf",
      "type": "file"
    },
    {
      "source": "./files/postgres-install.yml",
      "destination": "/tmp/postgres-install.yml",
      "type": "file"
    },
    {
      "type": "shell",
       "environment_vars": [
        "PACKER_SFTP_USERNAME={{ user `sftp_username` }}",
        "PACKER_SFTP_PASSWORD={{ user `sftp_password` }}",
        "PACKER_SFTP_USER_ROOT_LOGIN_DIR={{ user `sftp_user_root_login_dir` }}",
        "PACKER_DOTNET_INSTALL_PACKAGE={{ user `dotnet_install_package` }}",
        "PACKER_DB_NAME={{ user `db_name` }}",
        "PACKER_DB_USERNAME={{ user `db_username` }}",
        "PACKER_DB_PASSWORD={{ user `db_password` }}"
    ],
      "inline": [
        "### SETUP ###",

        "### NOTES ###",
        "# Digital Ocean is using root, does not need sudo",
        "# service for aspnetcore is kestrel-aspnetcore",

        "### START ###",

        "# SETUP SFTP",
        "useradd -m $PACKER_SFTP_USERNAME",
        "usermod -aG www-data $PACKER_SFTP_USERNAME",
        "echo $PACKER_SFTP_USERNAME:$PACKER_SFTP_PASSWORD | chpasswd",
        "## ADD USER TO SSHD",
        "echo | tee -a /etc/ssh/sshd_config",
        "echo Match User $PACKER_SFTP_USERNAME |tee -a /etc/ssh/sshd_config",
        "echo ForceCommand internal-sftp |tee -a /etc/ssh/sshd_config",
        "echo PasswordAuthentication yes |tee -a /etc/ssh/sshd_config",
        "echo ChrootDirectory $PACKER_SFTP_USER_ROOT_LOGIN_DIR |tee -a /etc/ssh/sshd_config",
        "echo PermitTunnel no |tee -a /etc/ssh/sshd_config",
        "echo AllowAgentForwarding no |tee -a /etc/ssh/sshd_config",
        "echo AllowTcpForwarding no |tee -a /etc/ssh/sshd_config",
        "echo X11Forwarding no |tee -a /etc/ssh/sshd_config",
        "systemctl restart sshd",

        "# SETUP DOT NET AND APACHE REVERSE PROXY",
        "echo deb [arch=amd64] https://apt-mo.trafficmanager.net/repos/dotnet-release/ trusty main > /etc/apt/sources.list.d/dotnetdev.list",
        "apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys 417A0893",
        "apt-get update",
        "apt-get install $PACKER_DOTNET_INSTALL_PACKAGE -y",
        "apt-get install apache2 -y",
        "a2enmod proxy proxy_http proxy_html",
        "## SETUP ASPNETCORE",
        "mv /tmp/aspnetcore.conf /etc/apache2/conf-available/aspnetcore.conf",
        "ln -s /etc/apache2/conf-available/aspnetcore.conf /etc/apache2/conf-enabled/",
        "systemctl restart apache2",
        "systemctl enable apache2",
        "mkdir ~/aspnetcore",
        "cd ~/aspnetcore && dotnet new mvc",
        "cd ~/aspnetcore && dotnet publish",
        "cp -a ~/aspnetcore/bin/Debug/netcoreapp2.0/publish/ /var/www/aspnetcore",
        "chown -R $PACKER_SFTP_USERNAME:$PACKER_SFTP_USERNAME /var/www/aspnetcore/",
        "mv /tmp/kestrel-aspnetcore.service /etc/systemd/system/kestrel-aspnetcore.service",
        "systemctl daemon-reload",
        "systemctl enable kestrel-aspnetcore",
        "systemctl start kestrel-aspnetcore",

        "# SETUP PHPPGADMIN",
        "apt-get install -y phppgadmin",
        "sed -i -e 's/Require\\ local/Allow\\ From\\ all/g' /etc/apache2/conf-available/phppgadmin.conf",
        "sed -i -e '1 a\\<VirtualHost *:81>' /etc/apache2/conf-available/phppgadmin.conf",
        "sed -i -e '1 a\\Listen 81' /etc/apache2/conf-available/phppgadmin.conf",
        "echo '</VirtualHost>' | tee -a /etc/apache2/conf-available/phppgadmin.conf",

        "# SETUP POSTGRES",
        "wget https://bootstrap.pypa.io/get-pip.py",
        "python3 ./get-pip.py",
        "pip install paramiko ansible psycopg2",
        "ansible-galaxy install geerlingguy.postgresql",
        "ansible-playbook /tmp/postgres-install.yml -e \"{'postgresql_databases':[{'name': $PACKER_DB_NAME}], 'postgresql_users':[{ 'name': $PACKER_DB_USERNAME, 'password': $PACKER_DB_PASSWORD}]}\""

      ]
    }
  ]
}
